<?php
/**
 * Generates a fully personalizable form.
 * @see CDatabase
 * @see CHtml
 * @see CDebug
 * @see CONSTANT
 * 
 * @author Morreale Luca
 */
class CForm extends CDebug{
    
    /**
     * Database manager.
     */
    private $db;

    public __construct($debug=false){

        $this->setDebug($debug);
        $this->db = new CDatabase(CONSTANT::database,CONSTANT::host,CONSTANT::user,CONSTANT::password);
        
        echo CHtml::cssFile('form');
        echo CHtml::cssFile('autocomplete');
        echo CHtml::script('',array('src' => 'http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js'));
        echo CHtml::script('',array('src' => 'http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js'));
        
        $this->debug(__FUNCTION__, null);
    }

    /**
     * Start the form.
     * @param $name      name of the form.
     * @param $action    url to request, as default is the same page the form was created.
     * @param $method    method to send data, as default is POST.
     */
    public function beginForm($name,$action=$_SERVER['REQUEST_URI'], $method='post'){
        echo CHtml::beginForm($action, $method, array('role'=>'form', 'accept-charset'=>'UTF-8', 'name'=>'form_'.$name));
        $this->debug(__FUNCTION__,array('name'=>$name,'action'=>$action, 'method'=>$method));
    }
    
    /**
     * Close the form.
     */
    public function endForm(){
        echo CHtml::endForm();
        $this->debug(__FUNCTION__,null);
    }

    /**
     * Generete the opening tag for the fieldset.
     */
    public function beginFieldset(){
        echo CHtml::openTag('fieldset');
        $this->debug(__FUNCTION__,null);
    }
    
    /**
     * Generete the closing tag for the fieldset.
     */
    public function endFieldset(){
        echo CHtml::closeTag('fieldset');
        $this->debug(__FUNCTION__,null);
    }
    
    /**
     * Generete the legend's tag.
     * @param $name    name of the fieldset.
     */
    public function insertLegend($name){
        echo CHtml::tag('legend',array(),$name);
        $this->debug(__FUNCTION__ ,$name);
    }

    /**
     * Inserts an input field with label
     * @param $type      type of the input field.
     * @param $name      name of the input field. (If you have to perform some search on db it has to have the same name of the field in the table)
     * @param $label       label for this item.
     * @param $option    html option like class or id for this field.
     */
    public function addField($type,$name, $label,$option=array()){

        echo CHtml::label($label.': ',$name);

        $option = $this->addBootstrap($option,$type);
        echo CHtml::inputField($type, $name, '', $option);

        $this->debug(__FUNCTION__ ,array('type'=>$type, 'name'=>$name, 'option'=>$option));
    }

    /**
     * Generates a Text Area.
     * @param $name     name of the textarea
     * @param $label       label for this item.
     * @param $option   array, parameter to set in the textarea
     * @param $text     text to set inside the textarea
     */
    public function insertArea($name, $label, $option=array(),$text=''){
        echo CHtml::label($label.': ',$name);
        $option['name']=$name;
        echo CHtml::tag('textarea',$option,$text);

        $this->debug(__FUNCTION__, array($htmlOptions,$text));
    }

    /**
     * Render an autocomplete field.
     * @param string $name      name of the input field.
     * @param mixed $data       information to extract data. Must be selected from the database only two field
     *                                                  one for the value field (with alias 'id') and the text (with alias as 'label')
     * @param $label       label for this item.
     * @param array $option     option for the input field. 
     */
    public function addAutocompleteField($name, $data, $label, $option=array()){
        
        static $n = 0;
        echo CHtml::label($label.': ', $name);

        $option['id'] = 'autocomplete_'.$n;
        $option['class'] = isset($option['class']) ? $option['class']." autocomplete" : "autocomplete";
        
        $this->addField($name."_autocomplete-textfield","text",$option);
        $this->addField($name,"hidden",array('id' => 'autocomplete_hidden_'.$n, 'class' => 'autocomplete'));
        

        if(isset($data['file'])){
            $script = '$(function() {
                            $("#autocomplete_"'.$n.'")autocomplete({
                                source: function (request, response) {
                                    $.ajax({
                                        url: '.$data['file'].',
                                        dataType: "json",
                                        data: request,
                                        success: function( data ) {
                                            response( $.map( data, function( item ) {
                                                $("#autocomplete_hidden_'.$n.'").val(ui.id);
                                            }));
                                        }
                                    }); 
                                },  
                                minLength: 2
                                }
                              });
                            });';
            echo CHtml::script($script);
        } else {
            foreach($data['query'] as $key => $value)
                $$key =  $value;
            $this->db->query_select($table,isset($where) ? $where :false, $field, isset($after_where) ? $after_where :false);
            $json = $this->generateJson();
            
            $script = '$(function () {
                        var data'.$n.' = '.$json.'
                            $("#autocomplete_'.$n.'").autocomplete({
                                source: data'.$n.'
                                select: function(event,ui){
                                    $("#autocomplete_hidden_'.$n.'").val(ui.id);
                                }
                                minLength: 2
                            });
                        });'
            echo CHtml::script($script);

        }
        $this->debug(__FUNCTION__, array($name,$data,$option));
    }
    /*
    Previous Version.
    $script = "$('#autocomplete_".$n."').autocomplete({
                        lookup: data".$n.",
                        onSelect: function (suggestion) {
                                $('#autocomplete_hidden_".$n."').val(suggestion.data);
                        }
                    });";

    function (request, response) {
                    var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");

                    var matching = $.grep(data'.$n.', function (value) {
                        var name = value.value;
                        var id = value.id;

                        return matcher.test(name) || matcher.test(id);
                    });
                    return response(matching);
                }

    */

    /**
     * Generates a Json file containing the info for the autocomplete field.
     * @return string
     */
    private function generateJson(){
        $a_json = array();
        $a_json_row = array();
        while($this->db->hasNextRecord()){
            $a_json_row["id"] = $this->db->getField("id");
            $a_json_row["label"] = $this->db->getField("label");
            array_push($a_json, $a_json_row);
        }

        $this->debug(__FUNCTION__, $a_json);
        return json_encode($a_json);
    }

    /**
     * Generates a dropdown list by a list
     * @param $name        name of the combo list
     * @param $data        array containing the data to create the list; Must be selected from the database only two field
     *                                                  one for the value field (with alias 'id') and the text (with alias as 'label')
     * @param $label       label for this item.
     * @param $option      array containing the style information.
     */
    public function insertComboList($name, $data, $label,$option=array()){
        
        echo CHtml::label($option['label'].': ',$name);
        
        $selected = isset($option["default"]) ? $option["default"] : 0;
        unset($option["default"]);
        
        $option['name']=$name;
        echo CHtml::openTag('select',$option);
        $this->renderOptionSet($data,$selected);  
        echo CHtml::closeTag('select').'\n';

        $this->debug(__FUNCTION__ ,array('name'=>$name,'data'=>$data, 'style'=>$option));
    }

    /**
     * Generate an option group.
     * @param $name        name for this input field.
     * @param $data        array containing the data for this input field.
     * @param $label       label for this item.
     * @param $option      style option.
     */
    public function insertOptionGroup($name, $data, $label,$option=array()){
        
        echo CHtml::label($label.': ', $name).'\n';

        $selected = isset($htmlOptions["default"]) ? $htmlOptions["default"] : 0;
        unset($option["default"]);
        
        $option['name']=$name;
        echo CHtml::openTag('select',$option);
        
        foreach($data as $opt => $group){
            
            echo CHtml::openTag('optgroup',array('label'=>$opt)).'\n';
            $selected -= $this->renderOptionSet($group, $selected);
            echo CHtml::closeTag('optgroup').'\n';
        }
        
        echo CHtml::closeTag('select');
        $this->debug(__FUNCTION__,array($data,$htmlOptions));
    }

    /**
     * Generate a DataList.
     * @param $name         name of the field.
     * @param $label        label of the input.
     * @param $data         array, list of data or a query to perform. The query must select two fields:
     *                                  the string to show must has alias 'label'; the value to send must has alias 'id'.
     * @param $option   array, parameters for the style. It must contains the key 'id'.
     */
    public function insertDataList($name, $label, $data,$option=array()){
                
        echo CHtml::label($label, $name).'\n';
        
        $options['name'] = $name;
        echo CHtml::tag('input',$option);
        
        echo CHtml::openTag('datalist',$option);
        
        $this->renderOptionSet($data);
        
        echo CHtml::closeTag('datalist');
        
        $this->debug(__FUNCTION__, array('name'=>$name,$data,$htmlOptions));
        
    }

    /**
     * Extracts values from database or array to render the option set.
     * @param $data        array with the needed information
     * @param $selected    item to selected
     * @return int  
     */
    protected function renderOptionSet($data, $selected=0){
        
        $count = 0;
        if(isset($data['query'])){
            
            if(is_array($data['query'])){
                $query = $this->extractQuery($data);
                $this->db->query_select($query['table'],$query['where'],$query['field'],$query['after_where']);
            } else {
                $this->db->query($data['query']);
            }

            while($this->db->hasNextRecord()){
                foreach($this->db->getRecord() as $key => $value)
                    $$key = $value;
                $html['value'] = $id;
                if($count == $selected){
                    $html["selected"] = 1;
                }
                echo CHtml::tag('option',array('value'=>$id),$label).'\n';
                $count++;
            }

        } else {
            
            foreach($data as $id => $label){
                $html['value'] = $id;
                if($count == $selected){
                    $html["selected"] = 1;
                }
                echo CHtml::tag('option',array('value'=>$id),$label).'\n';
                $count++;
            }

        }

        $this->debug(__FUNCTION__, array('data'=>$data , 'selected'=>$selected));
        return $count;
    }

    /**
     * Extract the information needed to perform a query from the array
     * @param $args    array containing information
     * @return array
     */
    private function extractQuery($args){
        $array['table'] = $args['table'];
        $array['field'] = $args['field'];
        if(!isset($args['where']))
            $array['where'] = array();
        else
            $array['where'] = $args['where'];
        if(!isset($args['after_where']))
            $array['after_where'] = array();
        else
            $array['after_where'] = $args['after_where'];

        return $array;
    }

    /**
     * Add class to get css from bootstrap files.
     * @param array $opt        html option
     * @param string $type      type of input field
     * @return array
     */
    protected function addBootstrap($opt,$type){
        if($type != "submit"){
            if(isset($opt['class'])){
                $opt['class'] .= " form-control";
            } else {
                $opt['class'] = "form-control";
            }
        } else {
            if(isset($opt['class'])){
                $opt['class'] .= " btn btn-lg btn-primary btn-block";
            } else {
                $opt['class'] = "btn btn-lg btn-primary btn-block";
            }
        }
        $this->debug(__FUNCTION__, array($opt,$type));
        return $opt;
    }

    /**
     * Generate an unique id for the session.
     */
    public function generateToken(){
        return md5( uniqid('auth', true) );
    }
}
?>